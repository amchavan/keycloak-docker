# The ALMA Keycloak implementation

The ALMA implementation of Keycloak is Docker-based.

The _Makefile_ sets up all configuratin information used by the _Dockerfile_, 
which then builds the Keycloak container image. You may need to adapt the 
Makefile to your local environment; the Dockerfile is very simple and is
probably general enough.

## Makefile

### Basic usage

`make clean all` will stop and delete the current container and remove
any intermediate files, the rebuild the container.

`make start` and `make stop` can be used to start and stop the container.

### Special case

`make push TAG=...` will push the image to DockerHub with a new tag;
see _DOCKERHUB\_USERNAME_ below for more info.

### Customization

You may want/need to change the definition of _LOCAL\_SHARED\_DIR_, 
a directory shared with the container. The directory must exist.

By default, Keycloak will be available on port 8080, change 
variable _PORT_ if needed.

If your local Maven repository is in a non-standard location you will need 
to change the definition of _M2_.

If you plan tp push container images to DockerHub you'll need to change
the definition of _DOCKERHUB\_USERNAME_.

## Configuration update

The runtime configuration of the Keycloak container is saved 
in the (container) 
directory _/opt/jboss/keycloak/standalone/data_. The Docker file copies
a dump of that directory (_keycloak-data.gzip_) from here
to the container, so that the server can
start with a full configuration.

If you change Keycloak via its admin UI you will need to create a 
new dump file before the container is brought down, or those
changes will be lost.

The following commands will create a new version of the dump file.
We assume you started Keycloak 
from this directory with `make start`, in which case the container 
ID is captured in file 
_/tmp/alma-keycloak.cid_.

```
# A couple of environment variables to help
LOCAL_SHARED_DIR=...                    # value of the LOCAL_SHARED_DIR variable in the Makefile
CID=$(cat /tmp/alma-keycloak.cid)       # retrieve the container's ID generated by 'docker run --detach'

# Copy Keycloak's database out to the shared directory 
docker exec -u 0 -it ${CID} bash -c "cd /opt/jboss/keycloak/standalone; cp -pr data /shared"

# Make sure all files and directories are fully accessible
chmod -R 777 ${LOCAL_SHARED_DIR}/data
(cd $LOCAL_SHARED_DIR ; tar cvzf keycloak-data.tgz data)
mv $LOCAL_SHARED_DIR/keycloak-data.tgz .
```

Remember to commit the new file back to Git.
